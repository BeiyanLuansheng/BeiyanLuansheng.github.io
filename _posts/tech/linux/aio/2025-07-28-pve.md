---
title: PVE部署AIO
author: BeiyanLuansheng
date: 2025-07-28 20:21:34 +0800
categories: [技术积累, AIO]
tags: [PVE]
---


## debain虚拟机

### 安装输入法

删除所有包：
```sh
apt purge fcitx*
apt pure ibus*
apt autoremove
```

安装ibus-rime
```sh
apt install ibus-rime
```

在 `系统设置->keyboard->Input Sources` 添加 `Chinese -> Chinese(Prime)` 重启ibus，已经可以输入中文了
```sh
ibus restart
```

安装双拼方案
```sh
apt install librime-data-double-pinyin
```

配置
```sh
cd 
cd .config/ibus/rime
touch default.custom.yaml
```

编辑文件 default.custom.yaml
```yaml
patch:
  schema_list:
    - schema: double_pinyin_flypy # 小鹤
    - schema: luna_pinyin_simp # 简体
    - schema: luna_pinyin # 繁体
  menu:
    page_size: 6 # 候选词数
```

编辑文件 `~/.config/ibus/rime/build/ibus_rime.yaml`
```yaml
style:
  horizontal: true # 水平展示
```

再重启ibus，快捷键 `Ctrl+`` 可以切换输入法设置

## LXC容器 (可选)
### 创建容器
1. 从 `数据中心 -> pve -> local -> CT模板 -> 模板` 下载模板
2. 创建CT，取消勾选无特权容器，开启嵌套，其余信息可以直接拉满

### 直通核显
1. 进入pve宿主机，查询硬件参数
```sh
ls -l /dev/dri
# 输出
total 0
drwxr-xr-x 2 root root         80 Jul 27 02:02 by-path
crw-rw---- 1 root video  226,   1 Jul 27 02:02 card1
crw-rw---- 1 root render 226, 128 Jul 27 02:02 renderD128
 - video  226,   1 是核显
 - render 226, 128 是渲染器
 - 下方会配置这两个信息
```

2. 编辑容器配置文件
```sh
nano /etc/pve/lxc/容器ID.conf

# 添加
lxc.cgroup2.devices.allow: c 226:1 rwm
lxc.cgroup2.devices.allow: c 226:128 rwm
lxc.cgroup2.devices.allow: c 29:0 rwm
lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
lxc.mount.entry: /dev/fb0 dev/fb0 none bind,optional,create=file
lxc.apparmor.profile: unconfined
lxc.cgroup.devices.allow: a
lxc.cap.drop:
```

4. 进入lxc，登录用户root，密码为创建容器填的
```
cd /dev/dri && ls
```
看到设备信息即可

### lxc容器配置

1. 换源，使用中科大镜像
```sh
sed -i 's/deb.debian.org/mirrors.ustc.edu.cn/g' /etc/apt/sources.list
# 更新
apt update
apt upgrade
```

2. 设置语言和时区
```sh
# echo 'LANG="zh_CN.UTF-8"' >> /etc/default/locale
dgkg-reconfigure locales
timedatectl set-timezone Asia/Shanghai
```

3. 开启root ssh
```sh
nano /etc/ssh/sshd_config

# 编辑添加
PermitRootLogin yes

# 保存，重启ssh
service ssh restart
```

## 安装docker
官方安装教程
```sh
apt-get install ca-certificates curl

install -m 0755 -d /etc/apt/keyrings

curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc

chmod a+r /etc/apt/keyrings/docker.asc

echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
  tee /etc/apt/sources.list.d/docker.list > /dev/null

apt-get update

apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
```

查看服务
```sh
# 版本
docker --version
Docker version 28.3.2, build 578ccf6

# 服务状态
systemctl status docker  
* docker.service - Docker Application Container Engine
     Loaded: loaded (/lib/systemd/system/docker.service; enabled; preset: enabled)
     Active: active (running) since Sun 2025-07-27 11:38:50 CST; 2min 12s ago
TriggeredBy: * docker.socket
       Docs: https://docs.docker.com
   Main PID: 11259 (dockerd)
      Tasks: 14
     Memory: 22.2M
        CPU: 237ms
     CGroup: /system.slice/docker.service
             `-11259 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock

Jul 27 11:38:49 lxc-debian dockerd[11259]: time="2025-07-27T11:38:49.696927872+08:00" level=info msg="CDI directory does not exist, skipping: failed to monitor for changes: no such file or directory" dir=/var/run/cdi
Jul 27 11:38:49 lxc-debian dockerd[11259]: time="2025-07-27T11:38:49.704224993+08:00" level=info msg="Creating a containerd client" address=/run/containerd/containerd.sock timeout=1m0s
Jul 27 11:38:49 lxc-debian dockerd[11259]: time="2025-07-27T11:38:49.765915506+08:00" level=info msg="Loading containers: start."
Jul 27 11:38:49 lxc-debian dockerd[11259]: time="2025-07-27T11:38:49.978540419+08:00" level=info msg="Loading containers: done."
Jul 27 11:38:49 lxc-debian dockerd[11259]: time="2025-07-27T11:38:49.999836821+08:00" level=info msg="Docker daemon" commit=e77ff99 containerd-snapshotter=false storage-driver=overlay2 version=28.3.2
Jul 27 11:38:49 lxc-debian dockerd[11259]: time="2025-07-27T11:38:49.999944188+08:00" level=info msg="Initializing buildkit"
Jul 27 11:38:50 lxc-debian dockerd[11259]: time="2025-07-27T11:38:50.039825898+08:00" level=info msg="Completed buildkit initialization"
Jul 27 11:38:50 lxc-debian dockerd[11259]: time="2025-07-27T11:38:50.045475250+08:00" level=info msg="Daemon has completed initialization"
Jul 27 11:38:50 lxc-debian dockerd[11259]: time="2025-07-27T11:38:50.045530834+08:00" level=info msg="API listen on /run/docker.sock"
Jul 27 11:38:50 lxc-debian systemd[1]: Started docker.service - Docker Application Container Engine.

# 自启动
systemctl is-enabled docker  
enabled
```

### 安装 portainer

```sh
# 创建卷
docker volume create portainer_data
# 启动服务
docker run -d -p 9000:9000 --name byls-portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v /opt/docker/portainer:/data portainer/portainer-ce:latest
```